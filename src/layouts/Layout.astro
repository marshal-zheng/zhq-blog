---
import { LOCALE, SITE } from "@config";
import "@styles/base.css";
import { ViewTransitions } from "astro:transitions";
import { SplashCursor } from "@components/SplashCursor";
import FloatingRobot from "@components/FloatingRobot";

const googleSiteVerification = import.meta.env.PUBLIC_GOOGLE_SITE_VERIFICATION;

export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
  assistantMode?: 'fullscreen' | 'bubble';
}

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage,
  canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  assistantMode = 'bubble',
} = Astro.props;

const currentPath = Astro.url.pathname;
const isPostDetail = /^\/posts\/[^/]+\/?$/.test(currentPath);

const socialImageURL = new URL(
  ogImage ?? SITE.ogImage ?? "og.png",
  Astro.url.origin
).href;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: `${title}`,
  image: `${socialImageURL}`,
  datePublished: `${pubDatetime?.toISOString()}`,
  ...(modDatetime && { dateModified: modDatetime.toISOString() }),
  author: [
    {
      "@type": "Person",
      name: `${author}`,
      url: `${profile}`,
    },
  ],
};
---

<!doctype html>
<html
  lang=`${LOCALE.lang ?? "en"}`
  class={`${scrollSmooth && "scroll-smooth"}`}
  data-theme="dark"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- General Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- WeChat -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content={SITE.title} />
    <meta property="og:locale" content={LOCALE.lang ?? "en"} />

    <!-- Article Published/Modified time -->
    {
      pubDatetime && (
        <meta
          property="article:published_time"
          content={pubDatetime.toISOString()}
        />
      )
    }
    {
      modDatetime && (
        <meta
          property="article:modified_time"
          content={modDatetime.toISOString()}
        />
      )
    }

    <script
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />

    <link rel="stylesheet" href="/css/fonts.css" />

    <meta name="theme-color" content="" />

    <ViewTransitions />

    <script is:inline src="/toggle-theme.js" async></script>
    <link rel="stylesheet" href="/css/katex.min.css" />
    
    <script is:inline>
      // ä¿å­˜æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡çš„æ ‡å¿—åˆ°windowå¯¹è±¡
      window.isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
  </head>
  <body class="relative">
    {!isPostDetail && <SplashCursor client:load />}
    <FloatingRobot client:load mode={assistantMode} />
    <slot />

    <!-- å®¢æˆ·ç«¯è„šæœ¬ï¼šåˆå§‹åŒ– API é€‚é…å™¨ -->
    <script>
      import { setupApiAdapter } from '@/services/api-adapter.service';
      
      // é˜²æ­¢é‡å¤åˆå§‹åŒ–
      if (!window.__apiAdapterInitialized) {
        try {
          // åˆå§‹åŒ– API é€‚é…å™¨
          setupApiAdapter();
          window.__apiAdapterInitialized = true;
          console.log('âœ… APIé€‚é…å™¨å·²åˆå§‹åŒ–');
        } catch (error) {
          console.error('âŒ APIé€‚é…å™¨åˆå§‹åŒ–å¤±è´¥:', error);
        }
      } else {
        console.log('âš ï¸  APIé€‚é…å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      }
    </script>

    <!-- å¾®ä¿¡äºŒç»´ç åŠ è½½ç›‘æ§è„šæœ¬ -->
    <script>
      // ç›‘æ§å¾®ä¿¡äºŒç»´ç å›¾ç‰‡çš„åŠ è½½æƒ…å†µ
      document.addEventListener('DOMContentLoaded', () => {
        // ç”±äºç°åœ¨ä½¿ç”¨æ‡’åŠ è½½ï¼Œå›¾ç‰‡åˆå§‹æ—¶æ²¡æœ‰srcå±æ€§ï¼Œéœ€è¦ç›‘æ§data-src
        const wechatImg = document.querySelector('img[data-src="/assets/wechat-qrcode.jpg"]');
        if (wechatImg) {
          console.log('ğŸ” å‘ç°å¾®ä¿¡äºŒç»´ç å›¾ç‰‡å…ƒç´ ï¼ˆæ‡’åŠ è½½æ¨¡å¼ï¼‰');
          
          // åˆ›å»ºMutationObserveræ¥ç›‘æ§srcå±æ€§çš„å˜åŒ–
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                const img = mutation.target as HTMLImageElement;
                if (img.src.includes('wechat-qrcode.jpg')) {
                  console.log('ğŸ–¼ï¸ å¾®ä¿¡äºŒç»´ç å›¾ç‰‡å¼€å§‹æ‡’åŠ è½½');
                  
                  img.addEventListener('load', () => {
                    console.log('âœ… å¾®ä¿¡äºŒç»´ç å›¾ç‰‡æ‡’åŠ è½½å®Œæˆ');
                  }, { once: true });
                  
                  img.addEventListener('error', () => {
                    console.error('âŒ å¾®ä¿¡äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥');
                  }, { once: true });
                }
              }
            });
          });
          
          observer.observe(wechatImg, { attributes: true, attributeFilter: ['src'] });
        } else {
          console.log('ğŸ” æœªæ‰¾åˆ°å¾®ä¿¡äºŒç»´ç å›¾ç‰‡å…ƒç´ ');
        }
        
        // ç›‘æ§æ‰€æœ‰å›¾ç‰‡è¯·æ±‚
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0];
          if (typeof url === 'string' && url.includes('wechat-qrcode.jpg')) {
            console.log('ğŸ” æ£€æµ‹åˆ°å¾®ä¿¡äºŒç»´ç å›¾ç‰‡è¯·æ±‚:', url);
          }
          return originalFetch.apply(this, args);
        };
        
        // ç›‘æ§æ‰€æœ‰ç½‘ç»œè¯·æ±‚
        if (window.performance && window.performance.getEntriesByType) {
          const checkImageRequests = () => {
            const entries = window.performance.getEntriesByType('resource');
            const wechatRequests = entries.filter(entry => 
              entry.name.includes('wechat-qrcode.jpg')
            );
            
            if (wechatRequests.length > 1) {
              console.warn('âš ï¸ æ£€æµ‹åˆ°å¾®ä¿¡äºŒç»´ç å›¾ç‰‡é‡å¤è¯·æ±‚:', wechatRequests.length, 'æ¬¡');
              wechatRequests.forEach((request, index) => {
                console.log(`è¯·æ±‚ ${index + 1}:`, {
                  æ—¶é—´: new Date(request.startTime).toLocaleTimeString(),
                  è€—æ—¶: `${(request.responseEnd - request.startTime).toFixed(2)}ms`,
                  URL: request.name
                });
              });
            } else if (wechatRequests.length === 1) {
              console.log('âœ… å¾®ä¿¡äºŒç»´ç å›¾ç‰‡åªè¯·æ±‚äº†ä¸€æ¬¡');
            }
          };
          
          // å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™é¡µé¢è¶³å¤Ÿçš„æ—¶é—´åŠ è½½
          setTimeout(checkImageRequests, 3000);
          
          // åœ¨é¡µé¢å¸è½½å‰æ£€æŸ¥
          window.addEventListener('beforeunload', checkImageRequests);
        }
      });
    </script>
  </body>
</html>
